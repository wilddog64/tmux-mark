#!/bin/bash

TEST_SESSION="test_tmux_mark"
TEST_TMUX_CONF="/tmp/tmux_mark_test.conf"
EMPTY_TMUX_CONF="/tmp/tmux_empty_test.conf"
PLUGIN_DIR="$(pwd)" # Dynamically determine the current directory
MARK_FILE="$HOME/.tmux-marks.json"
PASS_COUNT=0
FAIL_COUNT=0

pass() { echo "PASS: $1"; ((PASS_COUNT++)); }
fail() { echo "FAIL: $1"; ((FAIL_COUNT++)); }

# Step 1: Create temporary tmux configurations
echo "Creating temporary tmux configurations for testing..."

# Configuration with plugin loaded
cat > "$TEST_TMUX_CONF" <<EOL
run-shell "$PLUGIN_DIR/tmux-mark.tmux"
unbind m
unbind ]
unbind [
bind m run-shell "$PLUGIN_DIR/scripts/add_mark.sh"
bind ] run-shell "$PLUGIN_DIR/scripts/jump_next.sh"
bind [ run-shell "$PLUGIN_DIR/scripts/jump_prev.sh"
EOL

# Empty configuration for Test 4
cat > "$EMPTY_TMUX_CONF" <<EOL
# Empty configuration - No plugin bindings
EOL

# Function to ensure a clean tmux session
clean_tmux() {
    tmux kill-session -t "$TEST_SESSION" 2>/dev/null
}

# Test Case Function
run_expect_test() {
    local test_name="$1"
    local expect_script="$2"

    echo "Running $test_name..."
    expect -c "$expect_script"
    if [ $? -eq 0 ]; then
        pass "$test_name"
    else
        fail "$test_name"
    fi
}

# Step 2: Test Cases

# Test 1: Marks cannot be added outside copy mode
clean_tmux
run_expect_test "Test 1: Marks cannot be added outside copy mode" "
    spawn tmux -f \"$TEST_TMUX_CONF\" new-session -d -s \"$TEST_SESSION\"
    set timeout 5
    send \"tmux send-keys -t $TEST_SESSION m\\r\"
    expect {
        \"Error: Marks can only be added in copy mode.\" { exit 0 }
        timeout { exit 1 }
    }
"

# Test 2: Marks can be added in copy mode
clean_tmux
run_expect_test "Test 2: Marks can be added in copy mode" "
    spawn tmux -f \"$TEST_TMUX_CONF\" new-session -d -s \"$TEST_SESSION\"
    set timeout 5
    send \"tmux copy-mode\\r\"
    sleep 1
    send \"tmux send-keys -t $TEST_SESSION m\\r\"
    expect {
        \"Mark added at*\" { exit 0 }
        timeout { exit 1 }
    }
"

# Test 3: Jump to next mark
clean_tmux
run_expect_test "Test 3: Jump to next mark" "
    spawn tmux -f \"$TEST_TMUX_CONF\" new-session -d -s \"$TEST_SESSION\"
    set timeout 5
    send \"tmux copy-mode\\r\"
    sleep 1
    send \"tmux send-keys -t $TEST_SESSION m\\r\"
    send \"tmux send-keys -t $TEST_SESSION ]\\r\"
    expect {
        \"Jumped to mark*\" { exit 0 }
        timeout { exit 1 }
    }
"

# Test 4: Fail Case - Adding Marks Without Plugin
clean_tmux
run_expect_test "Test 4: Fail case - Adding marks without plugin" "
    spawn tmux -f \"$EMPTY_TMUX_CONF\" new-session -d -s \"$TEST_SESSION\"
    set timeout 5
    send \"tmux copy-mode\\r\"
    sleep 1
    send \"tmux send-keys -t $TEST_SESSION m\\r\"
    expect {
        \"Mark added at*\" { exit 1 }
        timeout { exit 0 }
    }
"

# Step 3: Cleanup
echo "Cleaning up test session and temporary configurations..."
clean_tmux
rm -f "$TEST_TMUX_CONF" "$EMPTY_TMUX_CONF" "$MARK_FILE"

# Step 4: Final Report
echo "---------------------------------------"
echo "Test Suite Completed."
echo "Passed: $PASS_COUNT"
echo "Failed: $FAIL_COUNT"
echo "---------------------------------------"

if [ $FAIL_COUNT -eq 0 ]; then
    echo "All tests passed successfully!"
    exit 0
else
    echo "$FAIL_COUNT test(s) failed."
    exit 1
fi
